name: Branch Name Lint

on:
  push:
    branches-ignore:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  lint-branch-name:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository with full history
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install branch-name-lint
      - run: npm install branch-name-lint --no-save

      # 4. Extract branch name
      - name: Extract branch name
        id: extract_branch
        shell: bash
        run: |
          if [ -n "$GITHUB_HEAD_REF" ]; then
            branch="$GITHUB_HEAD_REF"
          elif [ -n "$GITHUB_REF_NAME" ]; then
            branch="$GITHUB_REF_NAME"
          else
            branch="$(git symbolic-ref --short HEAD 2>/dev/null || \
                     git rev-parse --abbrev-ref HEAD 2>/dev/null || \
                     git name-rev --name-only HEAD 2>/dev/null || true)"
            if [ "$branch" = "HEAD" ] || [ -z "$branch" ]; then
              case "$GITHUB_REF" in
                refs/heads/*) branch="${GITHUB_REF#refs/heads/}" ;;
                refs/tags/*)  branch="${GITHUB_REF#refs/tags/}" ;;
                refs/pull/*/head) branch="${GITHUB_REF#refs/pull/}" ;;
                refs/pull/*/merge) branch="${GITHUB_REF#refs/pull/}" ;;
                *) branch="" ;;
              esac
            fi
          fi

          if [ -z "$branch" ]; then
            echo "ERROR: Could not determine branch name!"
            exit 1
          fi

          echo "Branch name detected: '$branch'"

          # Export to GITHUB_ENV and step outputs
          echo "BRANCH_NAME=$branch" >> "$GITHUB_ENV"
          echo "branch_name=$branch" >> "$GITHUB_OUTPUT"

      # 5. Run branch-name-lint using the step output
      - name: Check branch name
        run: npx branch-name-lint .branchlintrc.json
        env:
          BRANCH_NAME: ${{ steps.extract_branch.outputs.branch_name }}
