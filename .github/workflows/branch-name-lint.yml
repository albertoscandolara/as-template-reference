name: Branch Name Lint

on:
  push:
    branches-ignore:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  lint-branch-name:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install branch-name-lint --no-save

      - name: Extract branch name
        shell: bash
        run: |
          # Prefer PR source branch
          if [ -n "$GITHUB_HEAD_REF" ]; then
            BRANCH_NAME="$GITHUB_HEAD_REF"
          # Use the dedicated ref name variable if available (recommended)
          elif [ -n "$GITHUB_REF_NAME" ]; then
            BRANCH_NAME="$GITHUB_REF_NAME"
          else
            # Try multiple git-based methods, avoid literal "HEAD" fallback
            BRANCH_NAME="$(git symbolic-ref --short HEAD 2>/dev/null || \
                           git rev-parse --abbrev-ref HEAD 2>/dev/null || \
                           git name-rev --name-only HEAD 2>/dev/null || \
                           echo "")"
            # If we still have the literal "HEAD", try parsing GITHUB_REF
            if [ "$BRANCH_NAME" = "HEAD" ] || [ -z "$BRANCH_NAME" ]; then
              case "$GITHUB_REF" in
                refs/heads/*) BRANCH_NAME="${GITHUB_REF#refs/heads/}" ;;
                refs/tags/*) BRANCH_NAME="${GITHUB_REF#refs/tags/}" ;;
                refs/pull/*/merge) BRANCH_NAME="${GITHUB_REF#refs/pull/}" ;;
                *) BRANCH_NAME="" ;;
              esac
            fi
          fi

          # Export branch name for subsequent steps
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "Branch name detected: '$BRANCH_NAME'"

      - name: Fail early if branch name missing
        if: always()
        shell: bash
        run: |
          if [ -z "${{ env.BRANCH_NAME }}" ]; then
            echo "ERROR: Could not determine branch name. Aborting branch-name-lint."
            exit 1
          fi

      - name: Check branch name
        run: npx branch-name-lint .branchlintrc.json
        env:
          BRANCH_NAME: ${{ env.BRANCH_NAME }}